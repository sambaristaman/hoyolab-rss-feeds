name: Generate & Publish Global RSS (lean)

on:
  # run twice daily (UTC): 02:00 and 14:00
  schedule:
    - cron: '0 2 * * *'
    - cron: '0 14 * * *'
  # allow manual runs from the Actions tab
  workflow_dispatch:
  # optional: rebuild when source changes land on master
  push:
    branches: [ master ]
    paths:
      - 'src/**'
      - '.github/workflows/rss-pages.yml'
      - 'pyproject.toml'
      - 'hoyolab-rss-feeds.toml'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install minimal runtime deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install "aiohttp==3.11.18" "aiofiles==24.1.0" "pydantic>=1.10,<2"

      - name: Ensure minimal config exists
        run: |
          if [ ! -f hoyolab-rss-feeds.toml ]; then
            cat > hoyolab-rss-feeds.toml <<'EOF'
  [genshin]
  feed.json.path = "genshin.json"
  EOF
  fi

- name: Generate aggregated feeds
  env:
    PYTHONPATH: src
  run: |
    mkdir -p public
    # Atom (good for RSS readers)
    python -m hoyolabrssfeeds \
      --single-feed-path public/index.xml \
      --single-feed-format atom \
      --single-feed-title "Hoyolab – All Games" \
      --single-home-url "https://www.hoyolab.com/"
    # Optional JSON mirror
    python -m hoyolabrssfeeds \
      --single-feed-path public/index.json \
      --single-feed-format json \
      --single-feed-title "Hoyolab – All Games" \
      --single-home-url "https://www.hoyolab.com/"

- name: Upload Pages artifact
  uses: actions/upload-pages-artifact@v3
  with:
    path: public

deploy:
  needs: generate
  runs-on: ubuntu-latest
  environment:
    name: github-pages
    url: ${{ steps.deployment.outputs.page_url }}
  steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
